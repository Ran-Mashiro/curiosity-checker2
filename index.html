<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="セルフチェック計算ツール" />
  <meta name="format-detection" content="telephone=no">
  <title>セルフチェック計算ツール — OrphaX</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{ --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --line:#1f2937; --accent:#22c55e; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:linear-gradient(180deg,#0b1023,#0a0f1c 40%,#0b0f1a); color:var(--text); line-height:1.7;
    }
    header{padding:14px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10;background:rgba(0,0,0,.25);backdrop-filter:blur(6px)}
    .wrap{max-width:1000px;margin:0 auto;padding:0 16px}
    h1{margin:6px 0 4px;font-size:clamp(18px,3vw,26px)}
    .muted{color:var(--muted);font-size:.95rem}
    nav.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#0a1326;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#1a2a45,#0e1a33);border-color:#2a3b55}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    .grid{display:grid;gap:12px}
    @media(min-width:880px){.grid-2{grid-template-columns:1fr 1fr}}
    textarea,select,input[type="text"]{
      width:100%;border-radius:12px;border:1px solid var(--line);background:#0b1221;color:var(--text);padding:12px 14px;font-size:16px
    }
    textarea{min-height:160px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid var(--line);background:#111827;color:var(--text);border-radius:12px;padding:10px 14px;font-size:15px;cursor:pointer;touch-action:manipulation}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#16a34a);border:0;color:#041007;font-weight:700}
    .btn.ghost{background:transparent}
    .btn.warn{border-color:#7f1d1d;color:#fecaca}
    .chip{border:1px solid var(--line);background:#0a1326;padding:6px 10px;border-radius:999px;font-size:12px}
    .q{border-top:1px dashed var(--line);padding-top:12px;margin-top:12px}
    .q>.title{font-weight:700;margin-bottom:8px}
    .scale{display:flex;flex-wrap:wrap;gap:10px}
    .scale label{padding:8px 10px;border-radius:10px;background:#0a1326;border:1px solid var(--line)}
    input[type="radio"]{transform:scale(1.3)}
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    canvas{background:#0a1020;border-radius:12px;border:1px solid var(--line)}
    footer{color:var(--muted);text-align:center;padding:22px 12px}
    .actionbar{position:sticky;bottom:0;inset-inline:0;z-index:10;padding:10px;background:rgba(10,15,26,.9);backdrop-filter:blur(8px);border-top:1px solid var(--line)}
    .hidden{display:none!important}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px;background:#0b1221}
    .item .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .item input[type="text"]{width:auto;min-width:140px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>セルフチェック計算ツール</h1>
      <div class="muted">コピペ → グループ → 回答 → 集計（レーダー図／CSV）</div>
      <nav class="tabs">
        <button class="tab active" data-tab="edit">回答・編集</button>
        <button class="tab" data-tab="result">集計・出力</button>
        <button class="tab" data-tab="tpl">テンプレ（おまけ）</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- 回答・編集（メイン動線） -->
    <section id="tab-edit" class="tabpanel">
      <div class="card">
        <h2>1) バルク作成（まとめコピペ → 設問化）</h2>
        <!-- タイトル入力（保存名） -->
        <div class="row" style="margin-bottom:8px">
          <input id="titleInput" type="text" placeholder="タイトル（保存名） 例：セルフチェック 2025-08-26" />
        </div>
        <textarea id="bulk" placeholder="1行=1設問で貼り付け。番号や・は自動トリムします。"></textarea>
        <div class="row" style="margin-top:10px">
          <label>回答スケール：
            <select id="scale">
              <option value="5">5段階（1〜5）</option>
              <option value="7" selected>7段階（1〜7）</option>
              <option value="9">9段階（1〜9）</option>
            </select>
          </label>
          <input id="groupBulk" type="text" placeholder="一括グループ割当 例: A:1,3,4; B:2,7,9; C:5,8,10" />
          <input id="reverseBulk" type="text" placeholder="一括反転 例: 2,5,10" />
        </div>
        <div class="row">
          <button class="btn primary" id="btn-generate">設問を生成</button>
          <button class="btn ghost" id="btn-clear">クリア</button>
          <span class="muted">※グループ名は自動登録。指定がなければ <span class="chip">未割当</span> 。</span>
        </div>
      </div>

      <div class="card">
        <h2>2) グループ管理</h2>
        <div class="row">
          <input id="newGroupName" type="text" placeholder="新しいグループ名（例：A, 好奇心A）"/>
          <button class="btn" id="btn-add-group">グループを追加</button>
          <span class="muted">既定は <span class="chip">未割当</span></span>
        </div>
        <div id="groupList" class="row" style="margin-top:8px"></div>
        <!-- すべてクリア -->
        <div class="row" style="margin-top:8px">
          <button class="btn warn" id="btn-reset-all">すべてクリア</button>
        </div>
      </div>

      <div class="card">
        <h2>3) 設問一覧（回答・反転・グループ割当）</h2>
        <div id="questionList"></div>
      </div>

      <div class="actionbar">
        <div class="wrap">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <button class="btn primary" id="btn-calc">集計</button>
              <button class="btn" id="btn-save-session">セッション保存</button>
            </div>
            <div class="row muted"><span id="summary"></span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 集計・出力 -->
    <section id="tab-result" class="tabpanel hidden">
      <div class="card">
        <h2>4) 集計と可視化</h2>
        <div class="row" style="gap:8px;align-items:flex-end">
          <label class="row" style="gap:6px;">
            指標：
            <select id="metric">
              <option value="avg" selected>平均値</option>
              <option value="sum">合計値</option>
            </select>
          </label>
          <button class="btn" id="btn-export-raw">CSV（設問別）</button>
          <button class="btn" id="btn-export-group">CSV（グループ集計）</button>
          <button class="btn" id="btn-export-session">結果JSON保存</button>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <h3>グループ別スコア</h3>
          <table class="table" id="scoreTable">
            <thead><tr><th>グループ</th><th>件数</th><th id="metricHeader">平均</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h3>レーダー図</h3>
          <canvas id="radar"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>保存済みセッション</h2>
        <div id="sessionList" class="list"></div>
      </div>
    </section>

    <!-- テンプレ（おまけ） -->
    <section id="tab-tpl" class="tabpanel hidden">
      <div class="card">
        <h2>テンプレ読み込み・書き出し（おまけ）</h2>
        <div class="grid grid-2">
          <div class="card">
            <h3>ファイルからインポート</h3>
            <input type="file" id="tplFile" accept="application/json" />
            <div class="row"><button class="btn" id="btn-import-file">読み込む</button></div>
          </div>
          <div class="card">
            <h3>テキストからインポート</h3>
            <textarea id="tplText" placeholder='テンプレJSONをここに貼り付け'></textarea>
            <div class="row"><button class="btn" id="btn-import-text">読み込む</button></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>ローカル保存済みテンプレ</h3>
        <div id="tplList" class="list"></div>
        <div class="row" style="margin-top:8px;">
          <input id="tplNewName" type="text" placeholder="現在の状態をテンプレとして保存（名称）" />
          <button class="btn primary" id="btn-save-template">保存</button>
          <button class="btn" id="btn-export-template">テンプレ書き出し（JSON）</button>
        </div>
      </div>
    </section>
  </main>

  <footer>© OrphaX Curiosity Tools</footer>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ====== 状態・定数 ======
    const LS = { templates:'orpha:templates:v1', working:'orpha:working:v1', sessions:'orpha:sessions:v1' };
    let questions = []; // { id, text, reverse:false, group:'未割当', answer:null }
    let groups = new Set(['未割当']);
    let scaleMax = 7;
    let chart; // radar
    let templateMeta = { id:null, name:'Untitled', meta:{version:'1.0'} };

    // ====== ユーティリティ ======
    const $ = (s, root=document) => root.querySelector(s);
    const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));
    const uid = () => Math.random().toString(36).slice(2,9);
    const clampInt = (n, lo, hi) => Math.max(lo, Math.min(hi, Math.round(n)));
    const nowIso = () => new Date().toISOString();
    const nowFile = () => nowIso().replace(/[:T]/g,'-').split('.')[0];
    const parseIndexes = (txt) => (txt||'').split(',').map(s=>parseInt(s.trim(),10)).filter(n=>Number.isInteger(n)&&n>0);
    const sanitizeLine = s => s.replace(/^[\s\-・\d\.（）\(\)]*\s*/, '').trim();

    function downloadJSON(filename, obj){
      const blob = new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function downloadCSV(filename, rows){
      const csv = '\uFEFF'+rows.map(r=>r.map(v=>{
        const s=(v??'').toString().replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s;
      }).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ====== Storage ======
    const loadLS = (k, fallback) => { try{return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(fallback));}catch{return fallback;} };
    const saveLS = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const loadTemplatesLS = () => loadLS(LS.templates, {});
    const saveTemplatesLS = (obj) => saveLS(LS.templates, obj);
    const loadWorking = () => loadLS(LS.working, null);
    const saveWorking = () => saveLS(LS.working, { templateMeta, scaleMax, groups:[...groups], questions });
    const loadSessions = () => loadLS(LS.sessions, []);
    const saveSessions = (arr) => saveLS(LS.sessions, arr);

    // ====== タブ切替 ======
    $$('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        const name = btn.dataset.tab;
        $$('.tabpanel').forEach(p=>p.classList.add('hidden'));
        $('#tab-'+name).classList.remove('hidden');
        if(name==='result'){ renderSessions(); const byGroup=aggregate(); renderTableAndChart(byGroup); }
        if(name==='tpl'){ renderTemplateList(); }
      });
    });

    // ====== グループ一覧UI（×削除付き） ======
    function renderGroups(){
      const el = $('#groupList'); if(!el) return;
      el.innerHTML='';

      [...groups].forEach(g=>{
        const chip = document.createElement('span');
        chip.className='chip';
        chip.style.display='inline-flex';
        chip.style.alignItems='center';
        chip.style.gap='6px';
        chip.textContent = g;

        if(g !== '未割当'){
          const del = document.createElement('button');
          del.textContent = '×';
          del.title = 'このグループを削除';
          del.style.background = 'transparent';
          del.style.border = '0';
          del.style.color = 'var(--muted)';
          del.style.cursor = 'pointer';
          del.style.fontSize = '14px';
          del.addEventListener('click', ()=>{
            if(!confirm(`グループ「${g}」を削除しますか？\n（このグループに属する設問は「未割当」に戻ります）`)) return;
            groups.delete(g);
            questions.forEach(q=>{ if(q.group===g) q.group='未割当'; });
            renderGroups();
            renderQuestions();
            saveWorking();
          });
          chip.appendChild(del);
        }

        el.appendChild(chip);
      });
    }

    // ====== 設問UI ======
    function buildQuestionRow(q, idx){
      const wrap = document.createElement('div'); wrap.className='q';
      const title = document.createElement('div'); title.className='title'; title.textContent = `Q${idx+1}：${q.text}`; wrap.appendChild(title);
      // 回答
      const scale = document.createElement('div'); scale.className='scale';
      for(let n=1;n<=scaleMax;n++){
        const label=document.createElement('label'); label.style.display='inline-flex'; label.style.alignItems='center'; label.style.gap='8px';
        const input=document.createElement('input'); input.type='radio'; input.name=`ans_${q.id}`; input.value=String(n);
        input.checked = (q.answer===n);
        input.addEventListener('change', ()=>{ q.answer=n; saveWorking(); updateSummary(); });
        label.appendChild(input); label.appendChild(document.createTextNode(String(n))); scale.appendChild(label);
      }
      wrap.appendChild(scale);
      // 反転・グループ
      const row=document.createElement('div'); row.className='row';
      const revLabel=document.createElement('label'); const rev=document.createElement('input');
      rev.type='checkbox'; rev.checked=q.reverse;
      rev.addEventListener('change', ()=>{ q.reverse=rev.checked; saveWorking(); });
      revLabel.appendChild(rev); revLabel.appendChild(document.createTextNode(' 反転スコア（1⇔'+scaleMax+'）')); row.appendChild(revLabel);
      const sel=document.createElement('select');
      [...groups].forEach(g=>{ const opt=document.createElement('option'); opt.value=g; opt.textContent=g; if(q.group===g) opt.selected=true; sel.appendChild(opt); });
      sel.addEventListener('change', ()=>{ q.group=sel.value; saveWorking(); }); row.appendChild(sel);
      wrap.appendChild(row);
      return wrap;
    }
    function renderQuestions(){
      const box=$('#questionList'); if(!box) return;
      box.innerHTML=''; questions.forEach((q,i)=> box.appendChild(buildQuestionRow(q,i)));
      updateSummary();
    }

    // ====== 要約（未回答数など） ======
    function updateSummary(){
      const el = $('#summary'); if(!el) return;
      const answered = questions.filter(q=>typeof q.answer==='number').length;
      el.textContent = `回答数：${answered} / 全${questions.length}（未回答：${questions.length - answered}）`;
    }

    // ====== 反転／集計 ======
    const reverseScore = v => (scaleMax + 1) - v;
    function aggregate(){
      const byGroup={};
      for(const q of questions){
        if(typeof q.answer!=='number') continue;
        let v=q.answer; if(q.reverse) v=reverseScore(v);
        if(!byGroup[q.group]) byGroup[q.group]={ sum:0, n:0 };
        byGroup[q.group].sum += v; byGroup[q.group].n += 1;
      }
      return byGroup;
    }

    // ====== 表・レーダー描画 ======
    function renderTableAndChart(byGroup){
      const metric=$('#metric').value; // 'avg'|'sum'
      $('#metricHeader').textContent = (metric==='avg'?'平均':'合計');

      const tbody = $('#scoreTable tbody'); tbody.innerHTML='';
      const labels=[]; const values=[]; let maxN=0;

      // 未割当のみなら「グループなし」と表記
      const noCustomGroups = (groups.size === 1);

      Object.entries(byGroup).forEach(([g,{sum,n}])=>{
        maxN=Math.max(maxN,n); const val=(metric==='avg')?(n?sum/n:0):sum;
        const displayName = (g === '未割当' && noCustomGroups) ? 'グループなし' : g;

        const tr=document.createElement('tr'); tr.innerHTML=`<td>${displayName}</td><td>${n}</td><td>${val.toFixed(2)}</td>`; tbody.appendChild(tr);
        labels.push(displayName); values.push(+val.toFixed(2));
      });

      // 最大値（平均は段階数、合計は最大件数×段階数）
      const maxPossible = scaleMax * (maxN || 1);
      const rScale = (metric === 'avg')
        ? {
            beginAtZero: true,
            max: scaleMax,
            pointLabels:{ font:{ size:14 } },
            ticks:{ display:true, font:{ size:12 } }
          }
        : {
            beginAtZero: true,
            max: Math.max(scaleMax, maxPossible),
            pointLabels:{ font:{ size:14 } },
            ticks:{ display:true, font:{ size:12 } }
          };

      if(chart) chart.destroy();
      chart = new Chart($('#radar').getContext('2d'), {
        type:'radar',
        data:{ labels, datasets:[{ label:(metric==='avg'?'平均スコア':'合計スコア'), data:values, fill:true }] },
        options:{ responsive:true, scales:{ r:rScale }, plugins:{ legend:{ display:true, labels:{ font:{ size:14 } } } } }
      });
    }

    // ====== CSV / JSON 出力 ======
    function rawCSVRows(){
      const rows=[['Q','質問文','反転','グループ','回答(生)','回答(反転後)']];
      questions.forEach((q,i)=>{
        const raw = (typeof q.answer==='number')? q.answer : '';
        const adj = (typeof q.answer==='number')? (q.reverse? reverseScore(q.answer): q.answer) : '';
        rows.push([`Q${i+1}`, q.text, q.reverse?'yes':'no', q.group, raw, adj]);
      });
      return rows;
    }
    function groupCSVRows(byGroup){
      const metric=$('#metric').value;
      const rows=[[ 'グループ','件数', (metric==='avg'?'平均':'合計') ]];
      Object.entries(byGroup).forEach(([g,{sum,n}])=>{
        const val=(metric==='avg')?(n?sum/n:0):sum;
        const noCustomGroups = (groups.size === 1);
        const displayName = (g === '未割当' && noCustomGroups) ? 'グループなし' : g;
        rows.push([displayName,n,val.toFixed(2)]);
      });
      return rows;
    }
    function exportSessionJSON(){
      const byGroup=aggregate();
      const metric=$('#metric').value;
      const resp = questions.map((q,i)=>{
        const raw = (typeof q.answer==='number')? q.answer : null;
        const adj = (typeof q.answer==='number')? (q.reverse? reverseScore(q.answer): q.answer) : null;
        return { index:i+1, text:q.text, raw, reverse:q.reverse, adjusted:adj, group:q.group };
      });
      const stats={};
      Object.entries(byGroup).forEach(([g,{sum,n}])=>{
        stats[g]={ n, sum:+sum.toFixed(2), avg:+(n?sum/n:0).toFixed(2) };
      });
      const obj={ templateId: templateMeta.id, templateName: templateMeta.name, timestamp: nowIso(), scaleMax, metric, responses: resp, groupStats: stats };
      downloadJSON(`session_${nowFile()}.json`, obj);
    }

    // ====== セッション保存（localStorage） ======
    function saveSession(){
      const sessions=loadSessions();
      const byGroup=aggregate();
      // タイトル未入力なら自動命名
      templateMeta.name = (templateMeta.name && templateMeta.name.trim()) || `セッション ${nowFile()}`;
      const item={
        id:uid(), time: nowIso(), templateId: templateMeta.id, templateName: templateMeta.name,
        scaleMax, metric: $('#metric').value,
        answers: questions.map(q=>({ text:q.text, group:q.group, reverse:q.reverse, answer:q.answer })),
        byGroup
      };
      sessions.unshift(item); saveSessions(sessions); renderSessions(); alert('セッションを保存しました');
    }
    function renderSessions(){
      const box=$('#sessionList'); if(!box) return; box.innerHTML='';
      const sessions=loadSessions();
      if(sessions.length===0){ box.innerHTML='<div class="muted">（保存済みセッションはありません）</div>'; return; }
      sessions.forEach(s=>{
        const row=document.createElement('div'); row.className='item';
        const meta=document.createElement('div'); meta.className='meta';
        const name=document.createElement('span'); name.textContent = s.templateName || 'Session';
        const time=document.createElement('span'); time.className='muted'; time.textContent = new Date(s.time).toLocaleString();
        meta.appendChild(name); meta.appendChild(time);
        const ops=document.createElement('div'); ops.className='row';
        const bLoad=document.createElement('button'); bLoad.className='btn'; bLoad.textContent='読み込み';
        const bJson=document.createElement('button'); bJson.className='btn'; bJson.textContent='JSON出力';
        const bDel=document.createElement('button'); bDel.className='btn warn'; bDel.textContent='削除';
        ops.appendChild(bLoad); ops.appendChild(bJson); ops.appendChild(bDel);
        row.appendChild(meta); row.appendChild(ops); box.appendChild(row);

        bLoad.addEventListener('click', ()=>{
          templateMeta.id = s.templateId||uid(); templateMeta.name = s.templateName||'Session';
          scaleMax = s.scaleMax||7;
          groups = new Set(['未割当', ...new Set(s.answers.map(a=>a.group||'未割当'))]);
          questions = s.answers.map(a=>({ id: uid(), text:a.text, reverse:!!a.reverse, group:a.group||'未割当', answer: (typeof a.answer==='number')? a.answer : null }));
          renderGroups(); renderQuestions(); saveWorking();
          // タイトル欄へ反映
          $('#titleInput') && ($('#titleInput').value = templateMeta.name || '');
          alert('セッションを読み込みました（回答も復元）');
        });
        bJson.addEventListener('click', ()=> downloadJSON(`session_${nowFile()}.json`, s));
        bDel.addEventListener('click', ()=>{
          if(!confirm('このセッションを削除しますか？')) return;
          const arr=loadSessions().filter(x=>x.id!==s.id); saveSessions(arr); renderSessions();
        });
      });
    }

    // ====== テンプレ（おまけ） ======
    function currentTemplateObject(){
      return { id: templateMeta.id || uid(), name: templateMeta.name || 'Template', scaleMax, groups: [...groups],
        questions: questions.map(q=>({ text:q.text, reverse:q.reverse, group:q.group })), meta: templateMeta.meta||{version:'1.0'} };
    }
    function renderTemplateList(){
      const box = $('#tplList'); if(!box) return; box.innerHTML='';
      const map = loadTemplatesLS(); const ids = Object.keys(map);
      if(ids.length===0){ box.innerHTML = '<div class="muted">（まだ保存されたテンプレはありません）</div>'; return; }
      ids.forEach(id=>{
        const tpl = map[id];
        const row = document.createElement('div'); row.className='item';
        const meta = document.createElement('div'); meta.className='meta';
        const name = document.createElement('input'); name.type='text'; name.value = tpl.name||id;
        const small = document.createElement('span'); small.className='muted'; small.textContent = `${tpl.questions?.length||0}問 / scale${tpl.scaleMax||7}`;
        meta.appendChild(name); meta.appendChild(small);
        const ops = document.createElement('div'); ops.className='row';
        const bLoad = document.createElement('button'); bLoad.className='btn'; bLoad.textContent='読み込み';
        const bRename = document.createElement('button'); bRename.className='btn'; bRename.textContent='名称更新';
        const bExport = document.createElement('button'); bExport.className='btn'; bExport.textContent='書き出し';
        const bDel = document.createElement('button'); bDel.className='btn warn'; bDel.textContent='削除';
        ops.appendChild(bLoad); ops.appendChild(bRename); ops.appendChild(bExport); ops.appendChild(bDel);
        row.appendChild(meta); row.appendChild(ops); box.appendChild(row);

        bLoad.addEventListener('click', ()=> applyTemplate(tpl));
        bRename.addEventListener('click', ()=>{ tpl.name=name.value.trim()||tpl.name; map[id]=tpl; saveTemplatesLS(map); renderTemplateList(); });
        bExport.addEventListener('click', ()=> downloadJSON(`${(tpl.name||'template')}_${nowFile()}.json`, tpl));
        bDel.addEventListener('click', ()=>{ if(confirm('このテンプレを削除しますか？')){ delete map[id]; saveTemplatesLS(map); renderTemplateList(); }});
      });
    }
    function applyTemplate(tpl){
      templateMeta = { id: tpl.id||uid(), name: tpl.name||'Template', meta: tpl.meta||{version:'1.0'} };
      scaleMax = tpl.scaleMax || 7;
      groups = new Set(tpl.groups && tpl.groups.length ? tpl.groups : ['未割当']);
      questions = (tpl.questions||[]).map(q=>({ id: uid(), text:q.text, reverse:!!q.reverse, group:q.group||'未割当', answer:null }));
      renderGroups(); renderQuestions(); saveWorking();
      // タイトル欄に反映
      $('#titleInput') && ($('#titleInput').value = templateMeta.name || '');
      // メインタブに戻す
      $$('.tab').forEach(b=>b.classList.remove('active')); $$('[data-tab="edit"]')[0].classList.add('active');
      $$('.tabpanel').forEach(p=>p.classList.add('hidden')); $('#tab-edit').classList.remove('hidden');
    }

    // ====== 生成（バルク→質問） ======
    function applyBulkToQuestions(){
      const raw = ($('#bulk').value||'').trim();
      const scaleSel = parseInt($('#scale').value||'7',10);
      scaleMax = clampInt(scaleSel,3,11);

      const lines = raw.split(/\r?\n/).map(s=>sanitizeLine(s)).filter(s=>s.length>0);
      questions = lines.map(text=>({ id:uid(), text, reverse:false, group:'未割当', answer:null }));

      // 一括グループ割当
      const grpTxt = $('#groupBulk').value||'';
      if(grpTxt.trim()){
        grpTxt.split(';').forEach(seg=>{
          const [name, idxs] = seg.split(':');
          if(!name||!idxs) return;
          const gName=name.trim(); const list=parseIndexes(idxs);
          if(gName) groups.add(gName);
          list.forEach(n=>{ if(questions[n-1]) questions[n-1].group=gName; });
        });
      }
      // 一括反転
      const revTxt = $('#reverseBulk').value||'';
      parseIndexes(revTxt).forEach(n=>{ if(questions[n-1]) questions[n-1].reverse=true; });

      renderGroups(); renderQuestions(); saveWorking();
    }

    // ====== イベント配線 ======
    // タイトル入力 → templateMeta.name に反映
    $('#titleInput')?.addEventListener('input', ()=>{
      templateMeta.name = ($('#titleInput').value || '').trim() || 'Untitled';
      saveWorking();
    });

    // バルク生成
    $('#btn-generate').addEventListener('click', applyBulkToQuestions);
    $('#btn-clear').addEventListener('click', ()=>{ $('#bulk').value=''; $('#groupBulk').value=''; $('#reverseBulk').value=''; });

    // グループ追加
    $('#btn-add-group').addEventListener('click', ()=>{
      const name = ($('#newGroupName').value||'').trim(); if(!name){ alert('グループ名を入力してください'); return; }
      if([...groups].includes(name)){ alert('同名のグループがあります'); return; }
      groups.add(name); renderGroups(); renderQuestions(); $('#newGroupName').value=''; saveWorking();
    });

    // 全データクリア
    $('#btn-reset-all')?.addEventListener('click', ()=>{
      if(!confirm('設問・グループ・回答をすべて削除してリセットしますか？')) return;
      questions = [];
      groups = new Set(['未割当']);
      localStorage.removeItem(LS.working);
      renderGroups(); renderQuestions(); updateSummary();
    });

    // 集計
    $('#btn-calc').addEventListener('click', ()=>{
      const byGroup=aggregate(); renderTableAndChart(byGroup);
      // 集計タブへ
      $$('.tab').forEach(b=>b.classList.remove('active')); $$('[data-tab="result"]')[0].classList.add('active');
      $$('.tabpanel').forEach(p=>p.classList.add('hidden')); $('#tab-result').classList.remove('hidden');
    });
    $('#metric').addEventListener('change', ()=>{ const byGroup=aggregate(); renderTableAndChart(byGroup); });

    // CSV/JSON
    $('#btn-export-raw').addEventListener('click', ()=> downloadCSV(`items_raw_${nowFile()}.csv`, rawCSVRows()));
    $('#btn-export-group').addEventListener('click', ()=> downloadCSV(`groups_${$('#metric').value}_${nowFile()}.csv`, groupCSVRows(aggregate())));
    $('#btn-export-session').addEventListener('click', exportSessionJSON);
    $('#btn-save-session').addEventListener('click', saveSession);

    // テンプレ（おまけ）
    $('#btn-import-file')?.addEventListener('click', async ()=>{
      const f = $('#tplFile').files?.[0]; if(!f){ alert('JSONファイルを選択してください'); return; }
      try{ const text=await f.text(); const tpl=JSON.parse(text); applyTemplate(tpl); renderTemplateList(); }
      catch{ alert('JSONの読み込みに失敗しました'); }
    });
    $('#btn-import-text')?.addEventListener('click', ()=>{
      const t = $('#tplText').value.trim(); if(!t){ alert('JSONを貼り付けてください'); return; }
      try{ const tpl=JSON.parse(t); applyTemplate(tpl); renderTemplateList(); }
      catch{ alert('JSONの形式が不正です'); }
    });
    $('#btn-save-template')?.addEventListener('click', ()=>{
      const name=$('#tplNewName').value.trim(); if(!name){ alert('テンプレ名称を入力してください'); return; }
      const tpl=currentTemplateObject(); tpl.name=name; tpl.id = tpl.id || uid();
      const map=loadTemplatesLS(); map[tpl.id]=tpl; saveTemplatesLS(map);
      templateMeta.id=tpl.id; templateMeta.name=tpl.name; $('#tplNewName').value='';
      renderTemplateList(); alert('テンプレを保存しました');
    });
    $('#btn-export-template')?.addEventListener('click', ()=> downloadJSON(`${(templateMeta.name||'template')}_${nowFile()}.json`, currentTemplateObject()));

    // ====== 起動時：オート復元 ======
    (function restoreWorking(){
      const data = loadWorking();
      if(!data){ renderTemplateList(); return; }
      try{
        templateMeta = data.templateMeta || templateMeta;
        scaleMax = data.scaleMax || 7;
        groups = new Set(data.groups && data.groups.length ? data.groups : ['未割当']);
        questions = (data.questions||[]).map(q=>({ id:q.id||uid(), text:q.text, reverse:!!q.reverse, group:q.group||'未割当', answer:(typeof q.answer==='number')? q.answer : null }));
        // タイトル欄へ反映
        $('#titleInput') && ($('#titleInput').value = templateMeta.name || '');
        renderGroups(); renderQuestions(); renderTemplateList(); renderSessions();
      }catch(e){ console.error(e); }
    })();
  </script>
</body>
</html>
